<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Nostr Proof-of-burn</title>
    <script type="text/javascript" charset="utf-8" src="vendor/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="vendor/jquery-ui.min.js"></script>
    <script type="text/javascript" src="vendor/qrcode.js"></script>
    <link rel="stylesheet" type="text/css"
          href="vendor/jquery-ui-themes-1.12.1/themes/ui-lightness/jquery-ui.css">
    <style type="text/css">

      body {
	  font-family: Arial;
      }

      .tab {
	  overflow: hidden;
	  border: 1px solid #ccc;
	  background-color: #f1f1f1;
      }
      .tab button {
	  background-color: inherit;
	  float: left;
	  border: none;
	  outline: none;
	  cursor: pointer;
	  padding: 14px 16px;
	  transition: 0.3s;
      }
      .tab button:hover {
	  background-color: #ddd;
      }
      .tab button.active {
	  background-color: #ccc;
      }
      .tabcontent {
	  padding: 6px 12px;
	  border: 1px solid #ccc;
	  border-top: none;
      }
      .column {
	  float: left;
	  width: 50%;
      }
      .row{
	  padding: 26px 26px;
	  border: 1px solid #ccc;
      }
      .row:after {
	  content: "";
	  display: table;
	  clear: both;
      }
      .paybutton{
	  width:100%;
	  background-color:#ccc;
	  border-radius: 5px;
	  padding:10px;
      }
      #payreq{
	  overflow-wrap: break-word;
      }
      #progressbar {
	  position: relative;
	  background: #555;
      }
      .progress-label {
	  position: absolute;
	  top: 8px;
	  color: #fff;
	  font-weight: bold;
	  text-shadow: 1px 1px 0 #000;
      }
    </style>
</head>
<body>
  <div style="width:50em; margin:auto; font-family:arial, serif;">
    <h3>Proof-of-burn request status</h3>
      <div id="status"></div>
      <iframe id="frame" height="900" width="500" hidden="true" frameBorder="0"></iframe>
      <pre id="proof" hidden="true"></pre>
      <a id="link" hidden="true">View on block explorer</a>
    </div>
    <script type="text/javascript">

function getUrlParameter(sParam)
{
    var sPageURL = window.location.search.substring(1);
    var sURLVariables = sPageURL.split('&');
    for (var i = 0; i < sURLVariables.length; i++)
    {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam)
        {
            return sParameterName[1];
        }
    }
}
var rhash = getUrlParameter('rhash');
      
if (rhash) {
    var wss_address = (document.URL.startsWith("https") ? "wss" : "ws") + "://" + window.location.host +"/api/get_status?" + rhash;
    var payserver_address = (document.URL.startsWith("https") ? "https" : "http") + "://" + window.location.host +"/payserver/pay?id=" + rhash;
    $("#frame").attr('src', payserver_address);
    console.log("Opening WSS: " + wss_address);
    var ws = new WebSocket(wss_address);
    var received_msg;
      ws.onmessage = function (evt) {
	  data = $.parseJSON( evt.data );
	  console.log("data: " + data)
	  if(data.waiting){
	      $("#frame").show();
	      $("#status").hide();
	  }
	  else if(data.error){
	      $("#frame").hide();
	      $("#status").show();
	      $("#status").text(data.error);
	  }
	  else{
	      $("#frame").hide();
	      result = JSON.stringify(data, undefined, 2);
	      url = 'https://mempool.emzy.de/tx/' + data.txid;
	      $("#status").show();
	      $("#status").html('Proof received');
	      $("#proof").show();
	      $("#proof").text(result);
	      $("#link").show();
	      $("#link").attr('href', url);
	  }
      }
      ws.onerror = function () {
	  console.log("error ws.onerror");
	  $("#error").text("error with websocket. try reloading this page");
      };
      ws.onclose = function () {
	  console.log("error ws.onclose");
	  if(received_msg == 'waiting')
	      $("#error").text("error with websocket: socket was closed. try reloading this page");
      };

      // See http://stackoverflow.com/questions/29186154/chrome-clicking-mailto-links-closes-websocket-connection
      $(document).on('click', 'a[href^="bitcoin:"]', function (e) {
	  e.preventDefault();
	  var btcWindow = window.open($(e.currentTarget).attr('href'));
	  btcWindow.close();
	  return false;
      });
}
    
    </script>
</body>
</html>
